{% extends "minamo/base.html" %}   

{% block title %}{{ section.title }} - 編集{% endblock %}

{% block content %}
<ol class="breadcrumb hideable">
  <li class="breadcrumb-item">ホーム</li>
  <li class="breadcrumb-item">{{ book.title }}</li>
  <li class="breadcrumb-item">{{ chapter.title }}</li>
  <li class="breadcrumb-item active">{{ section.title }}</li>
</ol>
<button class="btn btn-secondary mb-3 hideable" id="hide-buttons">ボタンを非表示</button>
<div id="alert-box" class="position-relative">
    {% if request.GET.alert == 'True' %}
    <div class="alert alert-success alert-dismissible fade show" id="alert-saved" role="alert">
      保存しました。
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}
</div>
<form method="post" id="edit-section-form">
    {% csrf_token %}
    <div contenteditable="true" id="section-content-editor" class="form-control focus-ring">{{ section.content }}</div>
    <textarea name="content" rows="20" cols="100" class="form-control focus-ring d-none" id="section-content">{{ section.content }}</textarea>
    <div id="show-buttons" class="text-center mt-2 d-none">
        <a class="btn" id="show-buttons-button"></a>
    </div>
    <div id="submission" class="d-flex hideable">
            <button type="submit" class="btn btn-dark my-3 me-2" formaction="{% url 'minamo:edit_section' chapter.book.id chapter.id section.id %}"><i class="bi bi-save"></i> 保存</button>
            <button type="submit" class="btn btn-dark my-3 me-2" formaction="{% url 'minamo:edit_section_return' chapter.book.id chapter.id section.id 'chapter' %}">戻る</button> 
            <a class="btn btn-danger my-3 me-2" data-bs-toggle="modal" data-bs-target="#confirmModal">保存せずに戻る</a>
            <div class="text-end ms-auto">
                <span id="section-length" class="item-text align-top">文字数: {{ section.content|length }}</span>
            </div>
    </div>
</form>
<form class="hideable">
<button id="open-search" type="button" class="btn btn-secondary mb-3"><i class="bi bi-search"></i> 検索/置換</button>
<div id="search-replace-form" class="form-group row d-none">
    <div class="col-md-6">
        <input id="search-input" type="text" class="form-control mb-3" placeholder="検索して表示...">
    </div>
    <div class="col-md-6">
        <input id="replace-input" type="text" class="form-control mb-3" placeholder="置換後のテキスト...">
    </div>   
</div>
<a class="btn btn-dark mb-3 d-none" id="replace-button">置換</a>
<a class="btn btn-secondary mb-3 d-none" id="close-search">閉じる</a>
<p id="search-warning" class="d-none text-danger">検索文字列を入力してください。</p>
</form>

<!-- div for highlighting -->
<div id="highlight" class="position-absolute {% if user.configuration.text_vertical_align %}overflow-x-scroll{% else %}overflow-y-scroll{% endif %}" style="pointer-events: none;">
    <div id="highlight-content" class="position-relative d-none"></div>
</div>

<p id="debug"></p>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmModalLabel">確認</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        変更が保存されていません。このまま戻りますか？
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <a href="{% url 'minamo:book_detail' chapter.book.id %}" class="btn btn-danger">保存せずに戻る</a>
      </div>
    </div>
  </div>
</div>

{% endblock %} 

{% block extra_js %}
{{ configuration_json|json_script:"configuration" }}
{% if set_selection_json %}
{{ set_selection_json|json_script:"set_selection" }}
{% endif %}
<script>
$(document).ready(function() {
    const config = JSON.parse(document.getElementById('configuration').textContent);

    const cursorStorageKey = 'minamo:section-cursor:{{ section.id }}';
    const syncHighlightLayout = () => {
        const sectionContent = $('#section-content-editor')[0];
        $('#highlight').css('overflow', 'auto');
        $('#highlight-content').css('width', sectionContent.scrollWidth + 'px');
        $('#highlight-content').css('height', sectionContent.scrollHeight + 'px');
    };
    const syncHighlightScroll = () => {
        const sectionContent = $('#section-content-editor')[0];
        const highlight = $('#highlight')[0];
        highlight.scrollTop = sectionContent.scrollTop;
        highlight.scrollLeft = sectionContent.scrollLeft;
    };
    const saveCursorPosition = () => {
        const sectionContentEditor = $('#section-content-editor')[0];
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) {
            return;
        }
        const range = selection.getRangeAt(0);
        if (!sectionContentEditor.contains(range.startContainer)) {
            return;
        }
        const preCaretRange = range.cloneRange();
        preCaretRange.selectNodeContents(sectionContentEditor);
        preCaretRange.setEnd(range.startContainer, range.startOffset);
        const cursorPosition = preCaretRange.toString().length;
        localStorage.setItem(cursorStorageKey, String(cursorPosition));
    };
    const restoreCursorPosition = () => {
        const sectionContentEditor = $('#section-content-editor')[0];
        const savedPosition = localStorage.getItem(cursorStorageKey);
        if (savedPosition === null) {
            return;
        }
        const parsedPosition = Number(savedPosition);
        if (Number.isNaN(parsedPosition)) {
            return;
        }
        const textLength = sectionContentEditor.textContent.length;
        const cursorPosition = Math.max(0, Math.min(parsedPosition, textLength));
        const selection = window.getSelection();
        const range = document.createRange();
        const walker = document.createTreeWalker(sectionContentEditor, NodeFilter.SHOW_TEXT);
        let remaining = cursorPosition;
        let currentNode = walker.nextNode();
        let lastTextNode = null;

        while (currentNode) {
            lastTextNode = currentNode;
            const nodeLength = currentNode.textContent.length;
            if (remaining <= nodeLength) {
                range.setStart(currentNode, remaining);
                range.collapse(true);
                selection.removeAllRanges();
                selection.addRange(range);
                sectionContentEditor.focus();
                return;
            }
            remaining -= nodeLength;
            currentNode = walker.nextNode();
        }

        if (lastTextNode) {
            range.setStart(lastTextNode, lastTextNode.textContent.length);
            range.collapse(true);
        } else {
            range.selectNodeContents(sectionContentEditor);
            range.collapse(true);
        }
        selection.removeAllRanges();
        selection.addRange(range);
        sectionContentEditor.focus();
    };
    const normalizedIndexToTextareaIndex = (value, normalizedIndex) => {
        let rawIndex = 0;
        let normalizedCount = 0;
        const clampedIndex = Math.max(0, normalizedIndex);
        while (rawIndex < value.length && normalizedCount < clampedIndex) {
            if (value[rawIndex] === '\r' && value[rawIndex + 1] === '\n') {
                rawIndex += 2;
                normalizedCount += 1;
            } else {
                rawIndex += 1;
                normalizedCount += 1;
            }
        }
        return rawIndex;
    };
    const syncTextareaFromEditor = () => {
        const sectionContentEditor = $('#section-content-editor')[0];
        $('#section-content').val(sectionContentEditor.textContent);
    };
    const resolveTextNodePosition = (root, targetOffset) => {
        const walker = document.createTreeWalker(root, NodeFilter.SHOW_TEXT);
        let remaining = Math.max(0, targetOffset);
        let currentNode = walker.nextNode();
        let lastTextNode = null;

        while (currentNode) {
            lastTextNode = currentNode;
            const nodeLength = currentNode.textContent.length;
            if (remaining <= nodeLength) {
                return { node: currentNode, offset: remaining };
            }
            remaining -= nodeLength;
            currentNode = walker.nextNode();
        }

        if (lastTextNode) {
            return { node: lastTextNode, offset: lastTextNode.textContent.length };
        }
        return { node: root, offset: 0 };
    };
    const setEditorSelection = (startOffset, endOffset) => {
        const sectionContentEditor = $('#section-content-editor')[0];
        const textLength = sectionContentEditor.textContent.length;
        const clampedStart = Math.max(0, Math.min(startOffset, textLength));
        const clampedEnd = Math.max(0, Math.min(endOffset, textLength));
        const startPosition = resolveTextNodePosition(sectionContentEditor, clampedStart);
        const endPosition = resolveTextNodePosition(sectionContentEditor, clampedEnd);
        const selection = window.getSelection();
        const range = document.createRange();
        range.setStart(startPosition.node, startPosition.offset);
        range.setEnd(endPosition.node, endPosition.offset);
        selection.removeAllRanges();
        selection.addRange(range);
        sectionContentEditor.focus();
    };
    const scrollToCursor = () => {
        const sectionContentEditor = $('#section-content-editor')[0];
        const selection = window.getSelection();
        if (!selection || selection.rangeCount === 0) {
            return;
        }
        const originalRange = selection.getRangeAt(0).cloneRange();
        if (!sectionContentEditor.contains(originalRange.startContainer)) {
            return;
        }

        const markerRange = originalRange.cloneRange();
        markerRange.collapse(true);
        const marker = document.createElement('span');
        marker.textContent = '\u200b';
        markerRange.insertNode(marker);

        const editorRect = sectionContentEditor.getBoundingClientRect();
        const markerRect = marker.getBoundingClientRect();
        sectionContentEditor.scrollLeft += (markerRect.left - editorRect.left) - (sectionContentEditor.clientWidth / 2);
        sectionContentEditor.scrollTop += (markerRect.top - editorRect.top) - (sectionContentEditor.clientHeight / 2);

        marker.remove();
        selection.removeAllRanges();
        selection.addRange(originalRange);
    };
        
    if(config.text_vertical_align) {
        $('#section-content-editor').css('writing-mode', 'vertical-rl');
        $('#section-content-editor').css('text-orientation', 'mixed');
        $('#section-content-editor').css('height', (config.text_size * config.textarea_height + 30) + 'px');
        $('#edit-section-form').css('width', (config.text_size * 1.5 * config.textarea_width + 15) + 'px');
    } else {
        $('#section-content-editor').css('writing-mode', 'horizontal-tb');
        $('#section-content-editor').css('text-orientation', 'mixed');
        $('#section-content-editor').css('height', (config.text_size * 1.5 * config.textarea_height + 15) + 'px');
        $('#edit-section-form').css('width', (config.text_size * 1.5 * config.textarea_width + 45) + 'px');
    }
    $('#section-content-editor').css('font-size', config.text_size + 'px');
    $('#section-content-editor').css('line-height', (config.text_size * 1.5) + 'px');
    
    if($('#edit-section-form').outerWidth() > $('#main_container').width()) {
        $('#edit-section-form').css('width', '100%');
    }
    syncTextareaFromEditor();
    $('#section-length').text('文字数: ' + $('#section-content-editor')[0].textContent.length);
    offset = $('#section-content-editor').offset();
    width = $('#section-content-editor').outerWidth();
    height = $('#section-content-editor').outerHeight();
    $('#highlight').css('left', offset.left);
    $('#highlight').css('top', offset.top);
    $('#highlight').css('width', width);
    $('#highlight').css('height', height);
    syncHighlightLayout();
    syncHighlightScroll();
    if(config.text_vertical_align) {
        $('#highlight').css('writing-mode', 'vertical-rl');
        $('#highlight').css('text-orientation', 'mixed');
    } else {
        $('#highlight').css('writing-mode', 'horizontal-tb');
        $('#highlight').css('text-orientation', 'mixed');
    }
    $('#highlight-content').css('padding', $('#section-content-editor').css('padding'));
    $('#highlight-content').css('font-size', $('#section-content-editor').css('font-size'));
    $('#highlight-content').css('line-height', $('#section-content-editor').css('line-height'));
    $('#highlight-content').css('white-space', 'pre-wrap');
    $('#highlight-content').css('overflow-wrap', 'break-word');
    const setSelectionElement = document.getElementById('set_selection');
    if (setSelectionElement) {
        const set_selection = JSON.parse(setSelectionElement.textContent);
        const sectionContentEditor = $('#section-content-editor')[0];
        const content = sectionContentEditor.textContent;
        const start = normalizedIndexToTextareaIndex(content, set_selection.start);
        const end = normalizedIndexToTextareaIndex(content, set_selection.end);
        setEditorSelection(start, end);
    } else {
        restoreCursorPosition();
    }
    scrollToCursor();
    syncHighlightScroll();
    $('#section-content-editor').on('input', function() {
        syncTextareaFromEditor();
        $('#section-length').text('文字数: ' + this.textContent.length);
    });
    $('#edit-section-form').on('submit', function() {
        syncTextareaFromEditor();
    });
    $(window).on('beforeunload', function() {
        saveCursorPosition();
    });
    $('#open-search').on('click', function() {
        $('#search-replace-form').removeClass('d-none');
        $('#search-input').focus();
        $('#replace-button').removeClass('d-none');
        $('#close-search').removeClass('d-none');
        $(this).addClass('d-none');
    });
    $('#close-search').on('click', function() {
        $('#search-replace-form').addClass('d-none');
        $('#search-input').val('');
        $('#replace-input').val('');
        $('#search-warning').addClass('d-none');
        $('#replace-button').addClass('d-none');
        $('#close-search').addClass('d-none');
        $('#open-search').removeClass('d-none');
        $('#highlight-content').addClass('d-none');
    });
    $('#search-input').on('input click', function() {
        const query = $('#search-input').val();
        if (query) {
            const content = $('#section-content-editor')[0].textContent;
            const regex = new RegExp(query, 'gi');
            let highlightedContent = content.replace(regex, (match) => `<span class="highlight">${match}</span>`);
            highlightedContent = highlightedContent.replace(/\n/g, '<br>');
            $('#highlight-content').html(highlightedContent);
            $('.highlight').css('background-color', '#f80');
            $('#highlight-content').removeClass('d-none');
            syncHighlightLayout();
            syncHighlightScroll();
            requestAnimationFrame(syncHighlightScroll);
        } else {
            $('#highlight-content').addClass('d-none');
        }
    });
        $('#replace-button').click(function() {
            const query = $('#search-input').val();
            const replacement = $('#replace-input').val();
            if (query) {
                const sectionContentEditor = $('#section-content-editor')[0];
                const content = sectionContentEditor.textContent;
                const regex = new RegExp(query, 'gi');
                const newContent = content.replace(regex, replacement);
                sectionContentEditor.textContent = newContent;
                syncTextareaFromEditor();
                $('#section-length').text('文字数: ' + newContent.length);
                saveCursorPosition();
                $('#highlight-content').removeClass('d-none');
                const new_regex = new RegExp(replacement, 'gi');
                const highlightedContent = newContent.replace(new_regex, (match) => `<span class="highlight">${match}</span>`).replace(/\n/g, '<br>');
                $('#highlight-content').html(highlightedContent);
                $('.highlight').css('background-color', '#08f');
                syncHighlightLayout();
                syncHighlightScroll();
                requestAnimationFrame(syncHighlightScroll);
                $('#search-input').val('');
                $('#replace-input').val('');
                $('#search-warning').addClass('d-none');
            }
            else {
                $('#search-warning').removeClass('d-none');
                setTimeout(() => {
                    $('#search-warning').addClass('d-none');
                }, 2000);
            }
        });
    $('#section-content-editor').on('scroll', function() {
        syncHighlightScroll();
    });
    $('#section-content-editor').on('click', function() {
        $('#highlight-content').addClass('d-none');
    });
    $('#hide-buttons').click(function() {
        $('.hideable').addClass('d-none');
        $('#show-buttons').removeClass('d-none');
        offset = $('#section-content-editor').offset();
        $('#highlight').css('left', offset.left);
        $('#highlight').css('top', offset.top);
    });
    $('#show-buttons-button').click(function() {
        $('.hideable').removeClass('d-none');
        $('#show-buttons').addClass('d-none');
        offset = $('#section-content-editor').offset();
        $('#highlight').css('left', offset.left);
        $('#highlight').css('top', offset.top);
    });
    $(window).on('resize', function() {
        offset = $('#section-content-editor').offset();
        $('#highlight').css('left', offset.left);
        $('#highlight').css('top', offset.top);
    });
    setTimeout(() => {
        $('#alert-saved').alert('close');
    }, 1000);
});
</script>
{% endblock %}
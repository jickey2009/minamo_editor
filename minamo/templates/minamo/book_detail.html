{% extends "minamo/base.html" %}

{% block title %}{{ book.title }}{% endblock %}

{% block content %}
<ol class="breadcrumb">
  <li class="breadcrumb-item"><a href="{% url 'minamo:index' %}">ホーム</a></li>
  <li class="breadcrumb-item active">{{ book.title }}</li>
</ol>
<div class="d-flex flex-row">
    <a href="{%url 'minamo:new_chapter' book.id %}" class="btn btn-dark mb-3 me-2">新しい章を追加</a>
    <a class="btn btn-secondary mb-3" data-bs-toggle="button" id="swap-toggle">並べ替え</a>
    <a href="{% url 'minamo:export_book' book.id %}" class="btn btn-dark mb-3 ms-auto">本をエクスポート</a>
</div>
<div class="container text-left">
    {% for chapter in chapters %}
    <div class="card border-0 mb-3">
        <div class="row">
            <div class="col-md-4">
                <a href="{% url 'minamo:chapter_detail' book.id chapter.id %}" class="item-title ms-2" id="name{{ chapter.id }}">{{ chapter.title }}</a>
                <form id="form{{ chapter.id }}" class="d-none" method="post" action="{% url 'minamo:rename_chapter' book.id chapter.id %}" style="display: inline;">
                    {% csrf_token %}
                    <input id="input{{ chapter.id }}" type="text" name="title" value="{{ chapter.title }}" class="form-control d-inline-block w-auto">
                    <button id="save{{ chapter.id }}" type="submit" class="btn btn-primary d-none">保存</button>
                    <button id="cancel{{ chapter.id }}" type="button" class="btn btn-secondary d-none">キャンセル</button>
                </form>
                <button id="rename{{ chapter.id }}" class="btn"><i class="bi bi-pencil"></i></button>
            </div>
            
            <div class="col-md-8 text-end">
                <div class="col-md-2 d-inline-block me-3"><p class="align-middle text-nowrap item-text">{{chapter.length}}文字</p></div>
                <div class="d-inline-block mx-3 text-start">
                    <p class="mb-0 item-subtext">作成:</p>
                    <p class="mb-0 text-nowrap item-text">{{ chapter.created_date|date:"Y-m-d" }}</p>
                </div>
                <div class="d-inline-block mx-3 text-start">
                    <p class="mb-0 item-subtext">更新:</p>
                    <p class="mb-0 text-nowrap item-text">{{ chapter.updated_date|date:"Y-m-d" }}</p>
                </div>
                <div class="d-inline-block mb-2 text-start">
                    <button class="btn btn-danger me-2 notarrow" data-bs-toggle="modal" data-bs-target="#deleteModal{{ chapter.id }}">削除</button>
                    {% if not forloop.first %}
                    <a class="btn btn-secondary me-2 d-none arrow" href="{% url 'minamo:swap_chapter' book.id chapter.id 1 %}"><i class="bi bi-caret-up-fill"></i></a>
                    {% endif %}
                    {% if not forloop.last %}
                    <a class="btn btn-secondary me-2 d-none arrow" href="{% url 'minamo:swap_chapter' book.id chapter.id 3 %}"><i class="bi bi-caret-down-fill"></i></a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<a href="{% url 'minamo:index' %}" class="btn btn-secondary">ホームに戻る</a>

<!-- Delete Confirmation Modal -->
{% for chapter in chapters %}
<div class="modal fade" id="deleteModal{{ chapter.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ chapter.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel{{ chapter.id }}">章の削除確認</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        本当に「{{ chapter.title }}」を削除しますか？この操作は元に戻せません。
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <a href="{% url 'minamo:delete_chapter' book.id chapter.id %}" class="btn btn-danger">削除</a>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}    

{% block extra_js %}
{{ chapters_json|json_script:"chapters-data" }}
<script>
$(document).ready(function() {
    const chapters = JSON.parse(document.getElementById('chapters-data').textContent);
    chapters.forEach(chapter => {
        const chapterId = chapter.id;

        $('#rename' + chapterId).click(function() {
            $('#name' + chapterId).addClass('d-none');
            $('#input' + chapterId).removeClass('d-none');
            $('#save' + chapterId).removeClass('d-none');
            $('#cancel' + chapterId).removeClass('d-none');
            $(this).addClass('d-none');
        });
        $('#cancel' + chapterId).click(function() {
            $('#name' + chapterId).removeClass('d-none');
            $('#input' + chapterId).addClass('d-none');
            $('#save' + chapterId).addClass('d-none');
            $('#cancel' + chapterId).addClass('d-none');
            $('#rename' + chapterId).removeClass('d-none');
        });
    });
    $('#swap-toggle').on('click', function() {
        if ($(this).attr('aria-pressed') === 'true') {
            $('.arrow').removeClass('d-none');
            $('.notarrow').addClass('d-none');
        } else {
            $('.arrow').addClass('d-none');
            $('.notarrow').removeClass('d-none');
        }
    });
});
</script>
{% endblock %}
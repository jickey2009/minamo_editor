{% extends 'minamo/base.html' %}

{% block title %}Chapter {{ chapter.title }}{% endblock %}

{% block content %}
<ol class="breadcrumb">
  <li class="breadcrumb-item"><a href="{% url 'minamo:index' %}">ホーム</a></li>
  <li class="breadcrumb-item"><a href="{% url 'minamo:book_detail' chapter.book.id %}">{{ chapter.book.title }}</a></li>
  <li class="breadcrumb-item active">{{ chapter.title }}</li>
</ol>
<a href="{% url 'minamo:new_section' chapter.book.id chapter.id %}" class="btn btn-dark mb-3">新しい節を追加</a>

<div class="container text-left">
    {% for section in sections %}
    <div class="card border-0 mb-3">
        <div class="row">
            <div class="col-md-6">
                <a href="{% url 'minamo:edit_section' chapter.book.id chapter.id section.id %}" class="item-title ms-2" id="name{{ section.id }}">{{ section.title }}</a>
                <form id="form{{ section.id }}" class="d-none" method="post" action="{% url 'minamo:rename_section' chapter.book.id chapter.id section.id %}" style="display: inline;">
                    {% csrf_token %}
                    <input id="input{{ section.id }}" type="text" name="title" value="{{ section.title }}" class="form-control d-inline-block w-auto">
                    <button id="save{{ section.id }}" type="submit" class="btn btn-primary d-none">保存</button>
                    <button id="cancel{{ section.id }}" type="button" class="btn btn-secondary d-none">キャンセル</button>
                </form>
                <button id="rename{{ section.id }}" class="btn"><i class="bi bi-pencil"></i></button>
            </div>
            
            <div class="col-md-6 text-end">
                <div class="col-md-2 d-inline-block me-3"><p class="align-middle text-nowrap item-text">{{section.length}}文字</p></div>
                <div class="d-inline-block mx-3 text-start">
                    <p class="mb-0 item-subtext">作成:</p>
                    <p class="mb-0 text-nowrap item-text">{{ section.created_date|date:"Y-m-d" }}</p>
                </div>
                <div class="d-inline-block mx-3 text-start">
                    <p class="mb-0 item-subtext">更新:</p>
                    <p class="mb-0 text-nowrap item-text">{{ section.updated_date|date:"Y-m-d" }}</p>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-9"><p class="item-text ms-4 text-truncate">{{ section.content_head }}</p></div>
            <div class="col-md-3 mb-2 text-end">
                <a href="{% url 'minamo:section_detail' chapter.book.id chapter.id section.id %}" class="btn btn-secondary me-2">表示</a>
                <button class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal{{ section.id }}">削除</button>
            </div>
        </div>
    </div>
    {% endfor %}
</div>
<div class="mb-3">
    <a href="{% url 'minamo:book_detail' chapter.book.id %}" class="btn btn-secondary">本に戻る</a>
</div>

<!-- Delete Confirmation Modal -->
{% for section in sections %}
<div class="modal fade" id="deleteModal{{ section.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ section.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel{{ section.id }}">節の削除確認</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        本当に「{{ section.title }}」を削除しますか？この操作は元に戻せません。
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <a href="{% url 'minamo:delete_section' chapter.book.id chapter.id section.id %}" class="btn btn-danger">削除</a>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}

{% block extra_js %}
{{ sections_json|json_script:"sections-data" }}
<script>
$(document).ready(function() {
    const sections = JSON.parse(document.getElementById('sections-data').textContent);
    sections.forEach(section => {
        const sectionId = section.id;

        $('#rename' + sectionId).click(function() {
            $(this).addClass('d-none');
            $('#name' + sectionId).addClass('d-none');
            $('#input' + sectionId).removeClass('d-none');
            $('#save' + sectionId).removeClass('d-none');
            $('#cancel' + sectionId).removeClass('d-none');
        });

        $('#cancel' + sectionId).click(function() {
            $('#input' + sectionId).addClass('d-none');
            $('#save' + sectionId).addClass('d-none');
            $('#cancel' + sectionId).addClass('d-none');
            $('#name' + sectionId).removeClass('d-none');
            $('#rename' + sectionId).removeClass('d-none');
        });
    });
    $('#swap-toggle').change(function() {
        if ($(this).is(':checked')) {
            $('.arrow').removeClass('d-none');
            $('.btn-danger').addClass('d-none');
            $('.btn-info').addClass('d-none');
        } else {
            $('.arrow').addClass('d-none');
            $('.btn-danger').removeClass('d-none');
            $('.btn-info').removeClass('d-none');
        }
    });
});
</script>
{% endblock %}
{% extends "minamo/base.html" %}
{% load bootstrap4 %}
{% block title %}Minamo Editor{% endblock %}

{% block content %}
{% if user.is_authenticated %}
<ol class="breadcrumb">
  <li class="breadcrumb-item active">ホーム</li>
</ol>
<a href="{% url 'minamo:new_book' %}" class="btn btn-dark mb-3">新しい本を作成</a>
<div class="container text-left">
    {% for book in books %}
    <div class="card border-0 mb-3">
        <div class="row">
            <div class="col-md-6">
                <a href="{% url 'minamo:book_detail' book.id %}" class="item-title ms-2" id="name{{ book.id }}"><i class="bi bi-book"></i> {{ book.title }}</a>
                <form id="form{{ book.id }}" class="d-none" method="post" action="{% url 'minamo:rename_book' book.id %}" style="display: inline;">
                    {% csrf_token %}
                    <input id="input{{ book.id }}" type="text" name="title" value="{{ book.title }}" class="form-control d-inline-block w-auto">
                    <button id="save{{ book.id }}" type="submit" class="btn btn-primary d-none">保存</button>
                    <button id="cancel{{ book.id }}" type="button" class="btn btn-secondary d-none">キャンセル</button>
                </form>
                <button id="rename{{ book.id }}" class="btn"><i class="bi bi-pencil"></i></button>
            </div>
            
            <div class="col-md-6 text-end">
                <div class="col-md-2 d-inline-block me-3"><p class="align-middle text-nowrap item-text">{{book.length}}文字</p></div>
                <div class="d-inline-block mx-3 text-start">
                    <p class="mb-0 item-subtext">作成:</p>
                    <p class="mb-0 text-nowrap item-text">{{ book.created_date|date:"Y-m-d" }}</p>
                </div>
                <div class="d-inline-block mx-3 text-start">
                    <p class="mb-0 item-subtext">更新:</p>
                    <p class="mb-0 text-nowrap item-text">{{ book.updated_date|date:"Y-m-d" }}</p>
                </div>
            </div>
        </div>
        <div class="row">
            <div class="col-md-9"><p class="item-text ms-4">{{ book.description }}</p></div>
            <div class="col-md-3 mb-2 text-end">
                <a href="{% url 'minamo:edit_book' book.id %}" class="btn btn-dark me-2">編集</a>
                <button class="btn btn-danger me-2" data-bs-toggle="modal" data-bs-target="#deleteModal{{ book.id }}">削除</button>
            </div>
        </div>
    </div>
    {% empty %}
    <div class="alert alert-light" role="alert">
        まだ本がありません。新しい本を作成して、執筆を始めましょう！
    </div>
    {% endfor %}
</div>
    


<div class="pagination">
    <div class="step-links">
        {% if page_obj.has_previous %}
            <a href="?page=1">&laquo; first</a>
            <a href="?page={{ page_obj.previous_page_number }}">previous</a>
        {% endif %}
        <span class="current">
            Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}.
        </span>
        {% if page_obj.has_next %}
            <a href="?page={{ page_obj.next_page_number }}">next</a>
            <a href="?page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
        {% endif %}
    </div>
</div>
<a href="{% url 'minamo:settings' %}" class="btn btn-secondary mt-3 me-2">ユーザー設定</a>
<form action="{% url 'minamo:logout' %}" method="post" style="display: inline;">
    {% csrf_token %}
    <button type="submit" class="btn btn-secondary mt-3">ログアウト</button>
</form>

<!-- Delete Confirmation Modal -->
{% for book in books %}
<div class="modal fade" id="deleteModal{{ book.id }}" tabindex="-1" aria-labelledby="deleteModalLabel{{ book.id }}" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="deleteModalLabel{{ book.id }}">本の削除確認</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        本当に「{{ book.title }}」を削除しますか？この操作は元に戻せません。
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
        <a href="{% url 'minamo:delete_book' book.id %}" class="btn btn-danger">削除</a>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endif %}
{% if not user.is_authenticated %}
<div class="alert alert-info" role="alert">
    Minamo Editorへようこそ！アカウントを作成して、あなたの執筆活動を始めましょう。
</div>
<a href="{% url 'minamo:signup' %}" class="btn btn-primary">アカウント作成</a>
<a href="{% url 'minamo:login' %}" class="btn btn-secondary mt-3">ログイン</a>
{% endif %}

{% endblock %}

{% block extra_js %}
{{ books_json|json_script:"books-data" }}
<script>
    $(document).ready(function() {
        const books = JSON.parse(document.getElementById("books-data").textContent);
        books.forEach((book) => {
            const suffix = book.id;
            $("#rename" + suffix).click(function() {
                $(this).addClass("d-none");
                $("#name" + suffix).addClass("d-none");
                $("#form" + suffix).removeClass("d-none");
                $("#input" + suffix).removeClass("d-none");
                $("#save" + suffix).removeClass("d-none");
                $("#cancel" + suffix).removeClass("d-none");
            });
            $("#cancel" + suffix).click(function() {
                $("#name" + suffix).removeClass("d-none");
                $("#form" + suffix).addClass("d-none");
                $("#input" + suffix).addClass("d-none");
                $("#save" + suffix).addClass("d-none");
                $("#cancel" + suffix).addClass("d-none");
                $("#rename" + suffix).removeClass("d-none");
            });
        });
    });
</script>
{% endblock %}